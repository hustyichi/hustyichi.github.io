---
layout: post
title: "可控可信的工业界 Agent 方案研究 - parlant"
subtitle:   "Controllable and Trustworthy Industrial Agent Solutions - Parlant"
date:       2029-09-29 07:30:00
author:     "Bryan"
header-mask: 0.3
catalog:    true
tags:
    - llm
    - agent
---

## 背景介绍
一直以来，我都尝试将大模型 Agent 技术落地在相对严肃的医疗场景中，在这种场景下，对 Agent 的可靠性与合规性要求极高。为了提升 Agent 的可控性，需要大量算法 + 工程技术的叠加，比如之前分享过的基于 [BAML](https://zhuanlan.zhihu.com/p/1951981274425167989) 的结构化解析方案。最近刚好看到了主打 Agent 合规能力的开源 Agent 框架 [parlant](https://github.com/emcie-co/parlant)，结合官方方案介绍以及对应的开源实现了解其实现细节，感觉很有启发，本文就整理其中最核心的技术技术 ARQ。

## ARQ

ARQ 全称为 Attentive Reasoning Queries（注意力推理查询），此方案是 Parlant 的核心基础能力，可以有效提升 Agent 组件的一致性和可靠性。更难得的是，ARQ 的方案并不复杂，无需进行模型微调，相对简单就可以应用起来，官方称其为 COT 的升级版, 在论文 [Attentive Reasoning Queries: A Systematic Method for Optimizing Instruction-Following in Large Language Models](https://arxiv.org/pdf/2503.03669) 中有详细介绍。

#### 为什么

有 Agent 经验的开发者在面对大模型时往往会发现大模型很容易出现指令遵循相关的问题，特别是在问题相对复杂或者上下文较长的情况下，指令遵循的能力会大幅下降。这个与大模型底层的注意力机制有关，在模型推理过程中，随着上下文的增加，模型更容易忽略掉上下文中关键信息（特定是因为 [Lost in Middle](https://arxiv.org/abs/2307.03172) 忽略掉上下文中间的的关键信息），从而导致最终的输出结果偏离预期。

在之前的实践中，[COT](https://www.promptingguide.ai/techniques/cot) 是一个不错的提升方案，通过引导大模型输出中间推理结果，就像人在做复杂数学运算中自己给自己讲中间计算步骤一样，这样可以引入模型逐步进行推理，从而更容易给出最终的正确答案。而 ARQ 就是此思想的延伸，通过必要的中间状态的设计，提升最终结果的可靠性，主要用关键指令，决策和规避模型推理失败的问题。

#### 具体方案

ARQ 是通过人为设计的中间数据与推理链路，引导模型基于正确的信息进行逐步推理，从而提升最终结果的可靠性。整体机制建立在大模型的两大基础之上：

1. 结构化输出，ARQ 利用结构化输出可以精准控制模型输出的位置与格式，方便引导中间结果的输出；
2. LLM 的近因偏差，由于大模型最近的 token 会对输出影响较大，ARQ 会设计将关键信息输出前置输出，避免因为注意力机制忽略核心信息。

ARQ 机制包含的具体步骤如下所示：

1. 引导 ARQ 阶段：LLM 处理一系列预先确定的引导性问题，这些问题具有三个关键功能：

    - 恢复关键指令
    - 恢复提示中的重要上下文信息
    - 促进逐步推理和中间计算
2. 响应生成：根据主要引导阶段的结果，LLM 生成最终的响应;
3. （可选）响应验证：LLM 通过回答预定义的验证问题（例如，“响应是否与前导 ARQ 阶段中列出的约束一致？”）来评估其建议的响应是否满足所有要求。如果不一致，则生成并验证新的响应候选，直到找到令人满意的响应。

一个具体的案例如下所示：

![example](/img/in-post/arq/example.png)

可以看到不同方案的在进行餐厅推荐中差异：

- 直接调用大模型可能会直接给出最终的结论，作为一个黑盒流程，无法确定推荐的合理性；
- COT 方案引导先给出推荐理由，可以一定程度暴露推理链路，但是无法引导模型推理时关注核心信息；
- ARQ 方案会引导模型先确定群体的限制，口味偏好，可选餐厅以及餐厅的匹配程度，基于这些信息给出最终结论；

#### 结果比较

![result](/img/in-post/arq/result.png)

从结果上看，ARQ 方案在可信度与可靠性上都有明显提升, 特别是在复杂场景下，ARQ 方案引导模型正确推理的能力明显提升。

## Parlant 实践


